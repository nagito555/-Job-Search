
import requests
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

HEADHUNTER_API_URL = "https://api.hh.ru/vacancies"
DEFAULT_AREA = 113  # Москва

def format_salary(salary):
    if not salary:
        return "Не указана"
    salary_from = salary.get('from')
    salary_to = salary.get('to')
    currency = salary.get('currency', '')
    if salary_from and salary_to:
        return f"{salary_from} - {salary_to} {currency}"
    if salary_from:
        return f"От {salary_from} {currency}"
    if salary_to:
        return f"До {salary_to} {currency}"
    return "Не указана"

def get_vacancies(query: str, area=DEFAULT_AREA, per_page=5):
    params = {
        "text": query,
        "area": area,
        "per_page": per_page,
        "page": 0,
        "only_with_salary": True
    }
    response = requests.get(HEADHUNTER_API_URL, params=params)
    if response.status_code != 200:
        return None
    data = response.json()
    results = []
    for item in data.get('items', []):
        name = item.get('name')
        employer = item.get('employer', {}).get('name', 'Не указана компания')
        city = item.get('area', {}).get('name', 'Не указан город')
        salary = format_salary(item.get('salary'))
        url = item.get('alternate_url')
        results.append(f"*{name}*\nКомпания: {employer}\nГород: {city}\nЗарплата: {salary}\n[Ссылка на вакансию]({url})")
    return results if results else ["Вакансий по запросу не найдено."]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Привет! Я бот-исследователь рынка труда.\n"
        "Введите название профессии или ключевое слово для поиска вакансий в Москве."
    )

async def search_vacancies(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.message.text.strip()
    if not query:
        await update.message.reply_text("Пожалуйста, введите запрос для поиска вакансий.")
        return
    
    vacancies = get_vacancies(query)
    if vacancies is None:
        await update.message.reply_text("Произошла ошибка при обращении к API HeadHunter. Попробуйте позже.")
        return

    for vac in vacancies:
        await update.message.reply_text(vac, parse_mode='Markdown')

if __name__ == '__main__':
    application = ApplicationBuilder().token('8513886048:AAHQQ9BhBWQAoarxxvlo8hoRVbpqN0mD-X0').build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, search_vacancies))

    application.run_polling()

